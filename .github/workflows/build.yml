name: Build macOS Screensaver

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build (universal) into .saver bundle
        shell: bash
        run: |
          set -euo pipefail

          # Entramos a la carpeta real del proyecto
          cd SpaceInvadersScreensaver_Package

          # Validaciones (si falla acá, te dice exactamente qué falta)
          test -f SpaceInvadersScreensaver.swift
          test -d SpaceInvadersScreensaver.saver

          # Asegurar la carpeta del binario dentro del bundle
          mkdir -p SpaceInvadersScreensaver.saver/Contents/MacOS

          # Compilar universal (Intel + Apple Silicon)
          swiftc \
            -target x86_64-apple-macosx13.0 \
            -target arm64-apple-macosx13.0 \
            -framework Cocoa \
            -framework ScreenSaver \
            -framework WebKit \
            -emit-library \
            -o SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver \
            SpaceInvadersScreensaver.swift

          echo "✅ Built binary:"
          file SpaceInvadersScreensaver.saver/Contents/MacOS/SpaceInvadersScreensaver

      - name: Upload artifact (.saver)
        uses: actions/upload-artifact@v4
        with:
          name: SpaceInvadersScreensaver
          path: SpaceInvadersScreensaver_Package/SpaceInvadersScreensaver.saver
